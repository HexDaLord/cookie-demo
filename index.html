<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wie Websites dich erkennen ‚Äî Interaktive Demo (√úberarbeitet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --color-bg: #f6f8fa;
      --color-card: #ffffff;
      --color-primary: #4a90e2;
      --color-text-muted: #6b7280;
      --color-glass: rgba(255, 255, 255, 0.6);
      --color-border: #e6edf5;
      --color-shadow: rgba(2, 6, 23, 0.08);
      --color-shadow-light: rgba(2, 6, 23, 0.04);
      --gradient-header: linear-gradient(90deg, var(--color-primary), #2e6fb8);
      --gradient-info: linear-gradient(180deg, rgba(234, 244, 255, 0.5), transparent);
    }

    [data-theme="dark"] {
      --color-bg: #0f1724;
      --color-card: #0b1220;
      --color-primary: #60a5fa;
      --color-text-muted: #9ca3af;
      --color-glass: rgba(255, 255, 255, 0.03);
      --color-border: #2d3748;
      --color-shadow: rgba(0, 0, 0, 0.2);
      --color-shadow-light: rgba(0, 0, 0, 0.1);
      --gradient-header: linear-gradient(90deg, var(--color-primary), #3f6eb8);
      --gradient-info: linear-gradient(180deg, rgba(0, 50, 100, 0.3), transparent);
    }

    *,
    *::before,
    *::after { box-sizing: border-box; }

    body {
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--color-bg);
      color: var(--Color-text-muted);
      line-height: 1.5;
    }

    h1,h2,h3 { color: var(--color-primary); margin-top:0; }
    h1 { font-size:1.1rem; }
    h2 { margin-bottom:.5rem; }
    h3 { margin-bottom:.5rem; }

    .muted { font-size:.9rem; color:var(--color-text-muted); }

    pre {
      background: rgba(0,0,0,0.03);
      padding:.75rem;
      border-radius:8px;
      overflow:auto;
      font-size:.92rem;
      color:var(--color-text-muted);
      white-space: pre-wrap;
    }

    header {
      background: var(--gradient-header);
      color: white;
      padding:1.25rem 1rem;
      display:flex;
      gap:1rem;
      align-items:center;
      justify-content:space-between;
    }
    header .brand { display:flex; gap:.75rem; align-items:center; }
    header h1 { margin:0; color:white; }
    header p { margin:0; font-size:.86rem; opacity:.95; }

    main { max-width:1100px; margin:1.25rem auto; padding:1rem; position:relative; }

    .layout { grid-template-columns:450px 1fr; display:grid; gap:1rem; }

    .sidebar { position:sticky; top:1rem; align-self:start; }

    .card { background:var(--color-card); border-radius:12px; padding:1rem; box-shadow:0 6px 20px var(--color-shadow); color:var(--color-text-muted); }

    .content { display:flex; flex-direction:column; gap:1rem; min-height:600px; }

    section { padding:1rem; border-radius:12px; background:var(--color-card); box-shadow:0 6px 20px var(--color-shadow-light); }

    section.card.locked {
      pointer-events:none;
      opacity:0;
      filter:grayscale(100%);
      display:block;
    }

    .info { background:var(--gradient-info); padding:.6rem; border-left:4px solid var(--color-primary); border-radius:8px; color:var(--color-text-muted); text-align:justify; line-height:1.5; }

    footer { text-align:center; font-size:.82rem; color:var(--color-text-muted); margin-top:1rem; padding-top:1rem; }

    .content-spacer { height:500px; width:100%; }
    body::after { content:""; display:block; height:400px; }

    .progress { display:flex; flex-direction: column; gap:0.3rem}
    .step {background: var(--color-glass); padding: 0.35rem 0.55rem; border-radius: 8px; font-size: 0.90rem; line-height: 1.2; cursor: pointer;}
    .step.active { background:var(--gradient-header); color:white; }

    .controls { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.7rem; }

    /* ===== Compact Icon Toolbar f√ºr Schnellaktionen ===== */
    .icon-toolbar {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 Icons pro Reihe */
      gap: 0.4rem;
      align-items: center;
      justify-items: center;
      padding: 0.25rem 0;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--color-glass);
      border: 1px solid rgba(0,0,0,0.04);
      cursor: pointer;
      transition: transform .08s ease, background .12s ease;
      font-size: 0.92rem;
      color: var(--color-text-muted);
    }

    .icon-btn.primary {
      background: linear-gradient(180deg, rgba(74,144,226,0.12), rgba(74,144,226,0.06));
      border: 1px solid rgba(74,144,226,0.18);
      color: var(--color-primary);
    }

    .icon-btn.ghost {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.04);
      color: var(--color-primary);
    }

    .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    }

    .icon-label {
      display: none;
      font-size: 0.72rem;
      margin-top: 0.18rem;
      color: var(--color-text-muted);
      text-align: center;
    }

    @media (max-width: 600px) {
      .icon-toolbar { grid-template-columns: repeat(3, 1fr); gap: 0.35rem; }
      .icon-btn { width: 48px; height: 48px; }
      .icon-label { display: block; }
    }

    button { background:var(--color-primary); color:white; border:none; padding:.5rem .75rem; border-radius:8px; cursor:pointer; font-weight:600; transition:transform .1s ease, background-color .1s ease; }
    .btn-ghost { background:transparent; color:var(--color-primary); border:1px solid var(--color-glass); }
    button:active { transform:translateY(1px); }
    button:hover:not(:active) { opacity:.9; }

    .form-row { display:flex; gap:.5rem; margin-top:.6rem; flex-wrap:wrap; }
    input[type=text], input[type=password], select { flex:1; min-width:150px; padding:.5rem .6rem; border-radius:8px; border:1px solid var(--color-border); font-size:.95rem; background:var(--color-card); color:var(--color-text-muted); }
    input:focus, select:focus { outline:none; border-color:var(--color-primary); box-shadow:0 0 0 2px rgba(74,144,226,0.2); }

    label { font-weight:600; font-size:.95rem; color:var(--color-text-muted); }

    #map { height:280px; border-radius:8px; margin-top:.6rem; }

    table { width:100%; border-collapse:collapse; margin-top:.6rem; }
    th,td { padding:.45rem .5rem; text-align:left; border-bottom:1px solid rgba(0,0,0,0.05); font-size:.9rem; }
    th { color:var(--color-text-muted); }

    .badge { display:inline-block; padding:.2rem .45rem; border-radius:999px; font-size:.78rem; background:var(--color-glass); color:var(--color-text-muted); }

    #ad-banner { display:none; width:100%; background:var(--color-card); border-radius:12px; box-shadow:0 6px 20px var(--color-shadow); padding:.75rem; text-align:center; margin-top:1rem; }
    #ad-banner.active { display:block; animation:fadeIn .3s ease-out; }
    #ad-banner h4 { margin-top:0; margin-bottom:.5rem; color:var(--color-primary); }
    #ad-banner img { max-width:100%; height:auto; border-radius:8px; margin-bottom:.5rem; }
    #ad-banner p { font-size:.85rem; color:var(--color-text-muted); }

    @keyframes fadeIn { from { opacity:0; transform:scale(.97); } to { opacity:1; transform:scale(1); } }

    @media (max-width:1400px) {
      main { display:flex; flex-direction:column; gap:1rem; padding:1rem; max-width:none; }
      .layout { grid-template-columns:1fr; width:100%; }
      .sidebar { position:static; width:100%; order:2; }
      .content { width:100%; order:1; }
      #ad-banner { position:static; width:100%; margin-top:1rem; transform:translateX(0); order:3; }
    }
    @media (min-width:1025px) and (max-width:1400px) {
      main { flex-direction:row; align-items:flex-start; justify-content:center; flex-wrap:wrap; }
      .layout { grid-template-columns:320px 1fr; width:auto; flex-grow:1; }
      .sidebar { width:auto; position:sticky; top:1rem; order:unset; }
      .content { width:auto; order:unset; }
      #ad-banner { position:sticky; top:1rem; align-self:flex-start; width:250px; margin-left:1rem; order:unset; }
    }
    @media (max-width:1024px) { .layout { grid-template-columns:1fr; } .sidebar { position:static; width:100%; } }
    @media (max-width:768px) {
      header { flex-direction:column; align-items:flex-start; padding:1rem; }
      header .brand { margin-bottom:.5rem; }
      .form-row { flex-direction:column; }
      input, button, select { width:100%; min-width:unset; }
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand">
      <div style="font-size:1.5rem">üç™</div>
      <div>
        <h1>Wie Websites dich erkennen</h1>
        <p>Interaktive Unterrichts-Demo ‚Äì Schulstufe: 9. Klasse / AHS 5. Klasse</p>
      </div>
    </div>
    <div style="display:flex; gap:.6rem; align-items:center">
      <div class="muted" id="welcome-text">Willkommen!</div>
      <button id="theme-toggle" class="btn-ghost">Dark</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <aside class="sidebar">
        <div class="card">
          <h2>Schritt-f√ºr-Schritt</h2>
          <div class="muted">F√ºhre die Schritte durch, um Cookies & Tracking zu verstehen.</div>
          <div class="progress" id="progress">
            <div class="step" data-step="1">1. Cookies</div>
            <div class="step" data-step="2">2. Session vs Persistent</div>
            <div class="step" data-step="3">3. Ger√§t</div>
            <div class="step" data-step="4">4. Standort</div>
            <div class="step" data-step="5">5. Login</div>
            <div class="step" data-step="6">6. Tracking</div>
            <div class="step" data-step="7">7. Cookies Managen</div>
          </div>

          <div style="margin-top:.8rem" class="muted">Schnellaktionen</div>

          <div class="icon-toolbar" aria-label="Schnellaktionen">
            <button class="icon-btn primary" title="Cookies anzeigen / verstecken" onclick="toggleCookieTable()" aria-label="Cookies anzeigen">
              <!-- Cookie Icon -->
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 2a9 9 0 100 18 9 9 0 000-18z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="9.5" cy="10.5" r="1.2" fill="currentColor"/>
                <circle cx="14.2" cy="8.2" r="0.9" fill="currentColor"/>
                <circle cx="13.2" cy="13.2" r="0.8" fill="currentColor"/>
              </svg>
              <div class="icon-label">Cookies</div>
            </button>

            <button class="icon-btn ghost" title="Alle l√∂schen" onclick="clearAllCookies()" aria-label="Alle l√∂schen">
              <!-- Trash Icon -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M3 6h18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                <path d="M8 6v-1a2 2 0 012-2h4a2 2 0 012 2v1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                <path d="M10 11v6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                <path d="M14 11v6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                <rect x="4" y="6" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.2" />
              </svg>
              <div class="icon-label">L√∂schen</div>
            </button>

            <button class="icon-btn ghost" title="Seite neu laden (sim.)" onclick="simulateVisit()" aria-label="Simuliere Besuch">
              <!-- Reload Icon -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M21 12a9 9 0 10-3.2 6.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 3v6h-6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div class="icon-label">Reload</div>
            </button>
          </div>

          <div style="margin-top:.8rem" class="muted">Cookie-√úbersicht</div>
          <div id="cookie-table"></div>
        </div>

        <!-- Hier wurde die alte Sidebar-Session-vs-Persistent-Card entfernt, Inhalt ist jetzt im Hauptbereich -->
      </aside>

      <section class="content">
        <section class="card" data-step="1">
          <h3>üç™ 1. Cookies</h3>
          <div class="info">Diese Sektion erkl√§rt, was Cookies sind: kleine Textdateien, die eine Website in deinem Browser speichert. 
          Sie helfen einer Seite, sich Einstellungen zu merken ‚Äì zum Beispiel Sprache, Dark-Mode oder Begr√º√üungen. 
          Ohne Cookies w√ºrdest du f√ºr jede Website wie ein v√∂llig neuer Besucher wirken.
          
          <br><br>
          <b>Aufgabe:</b> Klicke auf ‚ÄûLos Gehts!‚Äú, um die Demo zu starten und den n√§chsten Bereich freizuschalten.
          </div>

          <div style="margin-top:.6rem">
            <div style="margin-top:.5rem" class="muted">Aktuelle Begr√º√üung:</div>
            <div style="display:flex; gap:0.5rem; margin-top:0.3rem; align-items:stretch;">
              <!-- Das pre Element bekommt flex:1, damit es den Platz f√ºllt -->
              <pre id="greeting" style="margin:0; flex:1; display:flex; align-items:center;">Hallo, Sch√ºler!</pre>
              <!-- Der Button daneben -->
              <button onclick="unlockPart2()" style="white-space:nowrap;">Los Gehts! üîì</button>
            </div>
          </div>
        </section>

        <!-- NEUE HAUPT-SEKTION: Session vs Persistent (jetzt Schritt 2) -->
        <section class="card" data-step="2">
          <h3>üîÅ 2. Session vs Persistent</h3>
          <div class="info">Hier lernst du den Unterschied zwischen Session- und Persistent-Cookies kennen. 
          Session-Cookies verschwinden, sobald du den Browser schlie√üt. 
          Persistente Cookies bleiben l√§nger gespeichert und halten z. B. deine Einstellungen oder Entscheidungen fest.
          
          <br><br>
          <b>Warum ist das wichtig?</b><br>  
          Ohne Session-Cookies k√∂nnten Seiten kein Login verwalten. Ohne persistente Cookies vergisst eine Seite deine Vorlieben.

          <br><br>
          <b>Aufgabe:</b> Setze jeweils ein Session- und ein Persistent-Cookie, um den n√§chsten Teil freizuschalten.
          </div>

          <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
            <button onclick="setPersistentDemo()">Persistent setzen</button>
            <button onclick="setSessionDemo()" class="btn-ghost">Session setzen</button>
            <button onclick="deleteCookie('demo_persistent')" class="btn-ghost">Persistent l√∂schen</button>
            <button onclick="deleteCookie('demo_session')" class="btn-ghost">Session l√∂schen</button>
          </div>

          <div style="margin-top:.6rem">
            <div class="muted">Cookie-Status:</div>
            <pre id="session-persistent-status">Status wird geladen...</pre>
          </div>
        </section>

        <section class="card" data-step="3">
          <h3>üíª 3. Ger√§tedaten</h3>
          <div class="info">Diese Sektion zeigt dir, welche technischen Informationen Webseiten ganz ohne Zustimmung auslesen k√∂nnen.

          <br><br>
          <b>Warum ist das wichtig?</b><br>  
          Solche Daten helfen Webseiten, sich an dein Ger√§t anzupassen ‚Äì k√∂nnen aber auch zum sogenannten ‚ÄûFingerprinting‚Äú beitragen, 
          womit man Nutzer wiedererkennen kann.

          <br><br>
          <b>Aufgabe:</b> Lass dir deine Ger√§tedaten anzeigen, um den n√§chsten Teil freizuschalten.
          </div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center">
            <button onclick="showDeviceInfo()">Daten anzeigen</button>
            <button onclick="clearDeviceInfo()" class="btn-ghost">L√∂schen</button>
          </div>
          <pre id="device-info">Noch keine Daten angezeigt.</pre>
        </section>

        <section class="card" data-step="4">
          <h3>üìç 4. Standort (nur mit Zustimmung)</h3>
          <div class="info">Webseiten d√ºrfen deinen Standort nur abfragen, wenn du zustimmst. 
          Je nach Ger√§t ist der Standort unterschiedlich genau (Handy sehr genau, Laptop eher ungenau).

          <br><br>
          <b>Warum ist das wichtig?</b><br>  
          Standortdaten geh√∂ren zu den sensibelsten Daten im Web und sollten bewusst freigegeben werden.

          <br><br>
          <b>Aufgabe:</b> Klicke auf ‚ÄûStandort abfragen‚Äú. Damit schaltest du den n√§chsten Bereich frei.
          </div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center">
            <button onclick="getLocation()">Standort abfragen</button>
            <button onclick="clearLocation()" class="btn-ghost">Karte verstecken</button>
          </div>
          <pre id="location-info">Noch keine Standortdaten.</pre>
          <div id="map" style="display:none"></div>
        </section>

        <section class="card" data-step="5">
          <h3>üîê 5. Register / Login (lokal & ohne Server)</h3>
          <div class="info">Viele Webseiten verwenden ein Login-System, um dich als Benutzer zu erkennen. 
          Beim Einloggen wird typischerweise ein Session-Cookie gesetzt, das dich w√§hrend deines Besuchs ‚Äûangemeldet‚Äú h√§lt.
          Gro√üe Websiten verwenden oft sowohl Session-Cookies als auch Persistente-Cookies, um dich nach einem Broswer-Neustart wieder automatisch einzuloggen. 
          Dein tats√§chliches Passwort wird dabei nie im Cookie gespeichert, denn man verwendet daf√ºr statdessen ein anonymes Token.

          <br><br>
          <b>Warum ist das wichtig?</b><br>  
          Ohne Session-Cookies w√ºrde die Seite nach jedem Klick vergessen, wer du bist.

          <br><br>
          <b>Aufgabe:</b> Registriere dich und logge dich ein. Danach wird der n√§chste Bereich freigeschaltet.
          </div>

          <div style="margin-top:.6rem">
            <div class="form-row">
              <input id="reg-username" type="text" placeholder="Benutzername" />
              <input id="reg-password" type="password" placeholder="Passwort" />
              <button onclick="registerUser()">Registrieren</button>
            </div>

            <div class="form-row" style="margin-top:.5rem">
              <input id="login-username" type="text" placeholder="Benutzername" />
              <input id="login-password" type="password" placeholder="Passwort" />
              <button onclick="loginUser()">Login</button>
              <button onclick="logoutUser()" class="btn-ghost">Logout</button>
            </div>

            <div style="margin-top:.6rem" class="muted">Session-Info:</div>
            <pre id="session-info">Nicht eingeloggt.</pre>
          </div>
        </section>

        <section class="card" data-step="6">
          <h3>üì¢ 6. Tracking-Simulation</h3>
          <div class="info">Tracking beschreibt Methoden, mit denen Webseiten oder Werbenetzwerke dich wiedererkennen k√∂nnen. 
          Oft geschieht das √ºber Tracking-Cookies, in denen eine eindeutige ID gespeichert wird.

          <br><br>
          <b>Warum ist das wichtig?</b><br> 
          Damit l√§sst sich z. B. Werbung personalisieren oder messen, wie oft Nutzer eine Seite besuchen. 
          In dieser Demo wird Tracking nur simuliert ‚Äì es werden keine echten Tracker verwendet.

          <br><br>
          <b>Aufgabe:</b> W√§hle eine Interessenskategorie und setze ein Tracking-Cookie, um den letzten Bereich freizuschalten.
          </div>
          <div style="margin-top:.6rem">
            <div class="form-row">
              <label for="ad-category-select">Was interessiert dich?</label>
              <select id="ad-category-select">
                <option value="">W√§hle ein Interesse</option>
                <option value="Mode">üëó Mode</option>
                <option value="Musik">üéß Musik</option>
                <option value="Tiere">üêæ Tiere</option>
                <option value="Kochen">üç≥ Kochen</option>
                <option value="Gaming">üéÆ Gaming</option>
              </select>
              <button onclick="setTracking()">Tracking setzen</button>
              <button onclick="simulateAd()" class="btn-ghost">Simuliere Ad-Targeting</button>
              <button onclick="clearTracking()" class="btn-ghost">Tracking l√∂schen</button>
            </div>
            <div style="margin-top:.5rem" class="muted">Tracking-Status:</div>
            <pre id="tracking-info">Tracking nicht gesetzt.</pre>
            <div id="ad-banner" class="card">
              <h4>Angebot nur f√ºr dich!</h4>
              <img id="ad-image" src="" alt="Werbebild">
              <p id="ad-text"></p>
              <button class="btn-ghost" onclick="hideAdBanner()">Schlie√üen</button>
            </div>
          </div>
        </section>

        <section class="card" data-step="7">
          <h3>üç™ 7. Cookies Managen</h3>
          <div class="info">Hier lernst du, wie du Cookies in deinem Browser ansehen oder l√∂schen kannst. 
          Das gibt dir Kontrolle dar√ºber, was Webseiten √ºber dich speichern und wie lange.
          
          <br><br>
          <b>Warum ist das wichtig?</b><br>  
          Viele Nutzer wissen nicht, dass sie jederzeit ihre gespeicherten Daten l√∂schen oder das Setzen neuer Cookies einschr√§nken k√∂nnen.

          <br><br>
          <b>Aufgabe:</b> Sieh dir das Video an. Es zeigt dir, wie du Cookies im Chrome-Browser verwaltest.
          </div>

          <div style="margin-top:.6rem">
            <div class="muted">Video:</div>
            <!-- Verwende mehrere Quellen (mp4/webm) falls vorhanden; poster ist optional -->
            <video id="cookies-video" controls preload="metadata" playsinline style="width:100%; border-radius:8px; margin-top:.5rem;">
              <source src="videos/cookie-demo-v1.mp4" type="video/mp4">
              Dein Browser unterst√ºtzt das Video-Tag nicht. <a href="videos/cookie-demo-v1.mp4" target="_blank" rel="noopener">Video herunterladen</a>.
            </video>

            <div class="muted" style="margin-top:.5rem"></div>
          </div>
        </section>


        <div class="content-spacer"></div>
        <footer>¬© Unterrichts-Demo ‚Äì Keine Daten werden an Server √ºbertragen.</footer>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ----------------------------- Helpers ----------------------------- */
    let maxUnlockedStep;
    let currentActiveStep = 1;
    let locationClicked = false;

    function setCookie(name, value, days) {
      let cookieString = `${name}=${encodeURIComponent(value)}; path=/`;
      if (typeof days === 'number' && days > 0) {
        const d = new Date();
        d.setTime(d.getTime() + days*24*60*60*1000);
        cookieString += `; expires=${d.toUTCString()}`;
      }
      document.cookie = cookieString;
      renderCookieTable();
      updateSessionPersistentStatus();
      checkAndUnlockSteps();
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
      return match ? decodeURIComponent(match[1]) : null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC`;
      renderCookieTable();
      updateSessionPersistentStatus();
      checkAndUnlockSteps();
    }

    function renderCookieTable() {
      const box = document.getElementById('cookie-table');
      const cookies = document.cookie.split(';').map(c => c.trim()).filter(Boolean);
      if (!cookies.length) {
        box.innerHTML = '<div class="muted">Keine Cookies gesetzt.</div>';
        return;
      }

      // Das M√ºlleimer-Icon (SVG Code)
      const trashIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M8 6v-1a2 2 0 012-2h4a2 2 0 012 2v1" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M10 11v6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M14 11v6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><rect x="4" y="6" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.2" /></svg>`;

      // Tabelle aufbauen
      let html = '<table><thead><tr><th>Name</th><th>Wert</th><th style="width:40px"></th></tr></thead><tbody>';
      cookies.forEach(c => {
        const [key, val] = c.split('=');
        // 'word-break:break-all' sorgt daf√ºr, dass lange Texte umbrechen und nicht aus der Sidebar ragen
        html += `<tr>
            <td>${key}</td>
            <td style="word-break:break-all; font-size:0.85rem">${decodeURIComponent(val || '')}</td>
            <td style="text-align:right;">
                <button onclick="deleteCookie('${key}')" class="btn-ghost" title="L√∂schen" style="padding:0.4rem; line-height:0; display:inline-flex; align-items:center;">${trashIcon}</button>
            </td>
        </tr>`;
      });

      html += '</tbody></table>';
      box.innerHTML = html;
      updateGreeting();
    }

    function updateGreeting() {
      const greetingElement = document.getElementById('greeting');
      const welcomeTextElement = document.getElementById('welcome-text');
      const name = sessionStorage.getItem('username');
      greetingElement.textContent = name ? `Hallo, ${name}!` : 'Hallo, Sch√ºler!';
      welcomeTextElement.textContent = name ? `Angemeldet: ${name}` : 'Willkommen!';
    }

    function unlockPart2() {
      if (maxUnlockedStep < 2) {
        maxUnlockedStep = 2;
        localStorage.setItem('maxUnlockedStep', '2'); // Speichern, damit es beim Reload bleibt
        checkAndUnlockSteps();
      }
      // Automatisch zu Schritt 2 scrollen
      document.querySelector('.step[data-step="2"]').click();
    }

    /* --------------------- Persistent vs Session Demo -------------------- */
    function setPersistentDemo() {
      setCookie('demo_persistent', 'persistentValue', 365);
      alert('Persistent Cookie "demo_persistent" gesetzt (l√§uft 365 Tage)');
    }

    function setSessionDemo() {
      setCookie('demo_session', 'tempValue');
      alert('Session Cookie "demo_session" gesetzt (verschwindet beim Schlie√üen des Tabs/Browsers)');
    }

    function updateSessionPersistentStatus() {
      const status = document.getElementById('session-persistent-status');
      const hasSession = !!getCookie('demo_session');
      const hasPersistent = !!getCookie('demo_persistent');
      status.textContent = `Session-Cookie (demo_session): ${hasSession ? 'gesetzt' : 'nicht gesetzt'}\nPersistent-Cookie (demo_persistent): ${hasPersistent ? 'gesetzt' : 'nicht gesetzt'}`;
    }

    /* --------------------- Device info -------------------- */
    function showDeviceInfo() {
      const info = {
        'User Agent': navigator.userAgent,
        'Sprache': navigator.language,
        'Cookies aktiviert': navigator.cookieEnabled,
        'Plattform': navigator.platform,
        'Bildschirm': `${window.screen.width}√ó${window.screen.height}`,
        'Zeitzone': Intl.DateTimeFormat().resolvedOptions().timeZone,
        'Uhrzeit': new Date().toLocaleString()
      };
      let text = '';
      for (const k in info) text += `‚Ä¢ ${k}: ${info[k]}\n`;
      document.getElementById('device-info').textContent = text;
      checkAndUnlockSteps();
    }

    function clearDeviceInfo() {
      document.getElementById('device-info').textContent = 'Noch keine Daten angezeigt.';
      checkAndUnlockSteps();
    }

    /* --------------------- Geolocation + Leaflet -------------------- */
    let map, marker;

    function getLocation() {
      const out = document.getElementById('location-info');
      const mapDiv = document.getElementById('map');
      
      locationClicked = true;
      if (maxUnlockedStep < 5) {
        maxUnlockedStep = 5;
        localStorage.setItem('maxUnlockedStep', maxUnlockedStep.toString());
        unlockStepsUI(maxUnlockedStep);
      }

      if (!navigator.geolocation) {
        out.textContent = '‚ùå Geolocation nicht unterst√ºtzt.';
        return;
      }
      out.textContent = 'üìç Standort wird abgefragt...';
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        out.textContent = `‚úÖ Standort:\nBreitengrad: ${lat.toFixed(5)}\nL√§ngengrad: ${lon.toFixed(5)}\nGenauigkeit: ¬±${Math.round(acc)} m`;
        mapDiv.style.display = 'block';
        if (!map) {
          map = L.map('map').setView([lat, lon], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap-Mitwirkende' }).addTo(map);
        } else { map.setView([lat, lon], 13); }
        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map).bindPopup('üìç Dein Standort').openPopup();
        checkAndUnlockSteps();
      }, err => {
        out.textContent = '‚ö†Ô∏è Standort konnte nicht ermittelt werden oder wurde abgelehnt.';
        mapDiv.style.display = 'none';
        checkAndUnlockSteps();
      });
    }

    function clearLocation() {
      document.getElementById('map').style.display = 'none';
      document.getElementById('location-info').textContent = 'Noch keine Standortdaten.';
      if (marker) { marker.remove(); marker = null; }
      if (map) { map.remove(); map = null; }
      checkAndUnlockSteps();
    }

    /* --------------------- Tracking Simulation -------------------- */
    const adContent = {
      'Mode': { image:'images/Fashion.png', text:'Entdecke die neuesten Trends! Exklusive Angebote f√ºr dich.', alt:'Modische Kleidung' },
      'Musik': { image:'images/Headphones.png', text:'Tauche ein in deine Lieblingsmusik! Headsets & mehr im Angebot.', alt:'Kopfh√∂rer' },
      'Tiere': { image:'images/Cat_Rice_Cooker.png', text:'Verw√∂hne deinen Vierbeiner! Gesundes Futter und Spielzeug.', alt:'Katzenfutter' },
      'Kochen': { image:'images/Cat_Rice_Cooker.png', text:'Kreiere Meisterwerke in deiner K√ºche! Entdecke unsere Reiskocher.', alt:'Reiskocher' },
      'Gaming': { image:'images/Headphones.png', text:'Hol dir den entscheidenden Vorteil! Top-Gaming-Gear warten auf dich.', alt:'Gaming Headset' }
    };

    function setTracking() {
      const id = Math.random().toString(36).slice(2,10);
      setCookie('tracking_id', id, 90);
      document.getElementById('tracking-info').textContent = `Tracking gesetzt: ${id}`;
    }

    function simulateAd() {
      const id = getCookie('tracking_id');
      if (!id) return alert('Kein Tracking gesetzt. Bitte zuerst "Tracking setzen".');
      const selectedCategory = document.getElementById('ad-category-select').value;
      if (!selectedCategory) return alert('Bitte w√§hle ein Interesse, um Ad-Targeting zu simulieren.');
      localStorage.setItem('last_category', selectedCategory);
      alert(`Simulierter Besuch: ${selectedCategory}. Beim n√§chsten Besuch k√∂nnte eine Ad f√ºr ${selectedCategory} erscheinen.`);
      document.getElementById('tracking-info').textContent = `Tracking aktiv (${id}). Letzte Kategorie: ${selectedCategory}`;
      showAdBanner(selectedCategory);
      checkAndUnlockSteps();
    }

    function clearTracking() {
      deleteCookie('tracking_id');
      localStorage.removeItem('last_category');
      document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
      renderCookieTable();
      hideAdBanner();
      checkAndUnlockSteps();
    }

    function simulateVisit() {
      const id = getCookie('tracking_id');
      const cat = localStorage.getItem('last_category');
      if (id && cat) {
        alert(`Wiederkehrender Besuch erkannt. Tracking-ID ${id} ‚Üí m√∂gliche Ad f√ºr ${cat}`);
        showAdBanner(cat);
      } else if (id) {
        alert(`Wiederkehrender Besucher (Tracking-ID ${id}). Kein Kategorie-Profil vorhanden.`);
        hideAdBanner();
      } else {
        alert('Kein Tracking vorhanden ‚Äî Besucher erscheint neu.');
        hideAdBanner();
      }
      checkAndUnlockSteps();
    }

    function showAdBanner(category) {
      const banner = document.getElementById('ad-banner');
      const img = document.getElementById('ad-image');
      const text = document.getElementById('ad-text');
      const content = adContent[category];
      if (content) {
        img.src = content.image; img.alt = content.alt; text.textContent = content.text; banner.classList.add('active');
      } else hideAdBanner();
    }
    function hideAdBanner() {
      const banner = document.getElementById('ad-banner');
      banner.classList.remove('active');
      document.getElementById('ad-image').src = '';
      document.getElementById('ad-text').textContent = '';
    }

    /* --------------------- Mini Register / Login -------------------- */
    function registerUser() {
      const u = document.getElementById('reg-username').value.trim();
      const p = document.getElementById('reg-password').value;
      if (!u || !p) return alert('Benutzername + Passwort erforderlich');
      const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
      if (users[u]) return alert('Benutzername existiert bereits');
      users[u] = { password: btoa(p) };
      localStorage.setItem('demo_users', JSON.stringify(users));
      alert('Registrierung erfolgreich (lokal). Du kannst dich jetzt einloggen.');
      document.getElementById('reg-username').value = ''; document.getElementById('reg-password').value = '';
    }

    function loginUser() {
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-password').value;
      if (!u || !p) return alert('Bitte Benutzername + Passwort eingeben');
      const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
      if (!users[u] || users[u].password !== btoa(p)) return alert('Ung√ºltige Anmeldedaten');
      setCookie('session_user', u); // session cookie in cookie table
      sessionStorage.setItem('username', u);
      updateSessionInfo(); renderCookieTable(); alert('Du bist jetzt eingeloggt.'); checkAndUnlockSteps();
      document.getElementById('login-username').value = ''; document.getElementById('login-password').value = '';
    }

    function logoutUser() {
      sessionStorage.removeItem('username');
      deleteCookie('session_user');
      updateSessionInfo(); renderCookieTable(); alert('Du wurdest ausgeloggt.'); checkAndUnlockSteps();
    }

    function updateSessionInfo() {
      const sessionUser = sessionStorage.getItem('username');
      document.getElementById('session-info').textContent = sessionUser ? `Eingeloggt als ${sessionUser} (Session-Cookie)` : 'Nicht eingeloggt.';
      updateGreeting();
    }

    let cookiesVisible = true;
    function toggleCookieTable() {
      const box = document.getElementById('cookie-table');
      cookiesVisible = !cookiesVisible; box.style.display = cookiesVisible ? 'block' : 'none';
    }

    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      const root = document.body; const theme = root.getAttribute('data-theme');
      const nextTheme = theme === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', nextTheme);
      themeToggle.textContent = nextTheme === 'dark' ? 'Light' : 'Dark';
      setCookie('theme_pref', nextTheme, 365);
    });

    function applySavedTheme() {
      const savedTheme = getCookie('theme_pref');
      if (savedTheme) { document.body.setAttribute('data-theme', savedTheme); themeToggle.textContent = savedTheme === 'dark' ? 'Light' : 'Dark'; }
    }

    function markActiveStep(stepNumber) {
      document.querySelectorAll('.step').forEach(el => {
        el.classList.toggle('active', Number(el.getAttribute('data-step')) === stepNumber);
      });
      currentActiveStep = stepNumber;
    }

    /**
     * Freischalt-Logik, aktualisiert f√ºr die neuen Step-IDs:
     * 1 Cookies
     * 2 Session vs Persistent (immer sichtbar)
     * 3 Login (freigeschaltet wenn demo_session && demo_persistent)
     * 4 Ger√§t (freigeschaltet wenn eingeloggt)
     * 5 Standort (freigeschaltet wenn device-info angezeigt)
     * 6 Tracking (freigeschaltet wenn Standort gesetzt)
     */
    function checkAndUnlockSteps() {
      const hasDemoSession = !!getCookie('demo_session');
      const hasDemoPersistent = !!getCookie('demo_persistent');

      // Wenn beide Demo-Cookies vorhanden sind -> mind. 3 freischalten
      if (hasDemoSession && hasDemoPersistent) {
        if (maxUnlockedStep < 3) maxUnlockedStep = 3;
      }

      // Schritt 4: Ger√§t ‚Äî wenn device-info angezeigt wurde (oder andere Bedingungen)
      if (document.getElementById('device-info').textContent !== 'Noch keine Daten angezeigt.') {
        if (maxUnlockedStep < 4) maxUnlockedStep = 4;
      }

      // Schritt 5: Login ‚Äî freischalten, sobald der Benutzer auf "Standort abfragen" geklickt hat
      if (locationClicked) {
        if (maxUnlockedStep < 5) maxUnlockedStep = 5;
      }

      // Schritt 6: Tracking ‚Äî NUR freischalten, wenn der Benutzer eingeloggt ist.
      // (Unabh√§ngig davon, ob Standort gesetzt wurde oder nicht)
      if (sessionStorage.getItem('username')) {
        if (maxUnlockedStep < 6) maxUnlockedStep = 6;
      }

      // Schritt 7: Cookies managen ‚Äî freischalten, sobald Tracking gesetzt wurde
      if (getCookie('tracking_id')) {
        if (maxUnlockedStep < 7) maxUnlockedStep = 7;
      }

      // Persistieren und UI aktualisieren
      localStorage.setItem('maxUnlockedStep', maxUnlockedStep.toString());
      unlockStepsUI(maxUnlockedStep);

      if (currentActiveStep > maxUnlockedStep) {
        markActiveStep(maxUnlockedStep);
      } else {
        markActiveStep(currentActiveStep);
      }
    }


    function unlockStepsUI(unlockedCount) {
      document.querySelectorAll('.step').forEach(step => {
        const stepNum = Number(step.getAttribute('data-step'));
        step.style.pointerEvents = stepNum <= unlockedCount ? 'auto' : 'none';
        step.style.opacity = stepNum <= unlockedCount ? '1' : '0.4';
        if (stepNum <= unlockedCount && !step.dataset.listenerAdded) {
          step.addEventListener('click', () => { markActiveStep(stepNum); scrollToSection(stepNum); });
          step.dataset.listenerAdded = 'true';
        }
      });

      document.querySelectorAll('section.card[data-step]').forEach(sec => {
        if (sec.dataset.always === 'true') { sec.classList.remove('locked'); return; }
        const stepNum = Number(sec.getAttribute('data-step'));
        sec.classList.toggle('locked', stepNum > unlockedCount);
      });
    }

    function scrollToSection(stepNumber) {
      setContentMinHeight();
      const section = document.querySelector(`section.card[data-step="${stepNumber}"]`);
      const progressCard = document.querySelector('.sidebar .card:first-child');
      if (section && progressCard) {
        const progressRect = progressCard.getBoundingClientRect();
        const sectionTop = section.getBoundingClientRect().top + window.scrollY;
        let scrollTarget = sectionTop - progressRect.top;
        const maxScroll = document.body.scrollHeight - window.innerHeight;
        if (scrollTarget > maxScroll) scrollTarget = maxScroll;
        window.scrollTo({ top: scrollTarget, behavior: 'smooth' });
      }
    }

    function setContentMinHeight() {
      const sidebar = document.querySelector('.sidebar .card:first-child');
      const content = document.querySelector('section.content');
      if (sidebar && content) content.style.minHeight = sidebar.offsetHeight + 'px';
    }

    window.addEventListener('resize', setContentMinHeight);
    window.addEventListener('load', setContentMinHeight);

    function clearAllCookies() {
      if (confirm('Alle Cookies, LocalStorage und SessionStorage l√∂schen? Dies l√∂scht auch Login-Sessions und Tracking-Daten.')) {
        document.cookie.split(';').forEach(c => {
          const name = c.split('=')[0].trim();
          if (name) deleteCookie(name);
        });
        localStorage.clear();
        sessionStorage.clear();
        updateSessionInfo(); updateGreeting();
        document.getElementById('device-info').textContent = 'Noch keine Daten angezeigt.';
        document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
        clearLocation(); renderCookieTable(); hideAdBanner();
        alert('Alle Daten gel√∂scht.');
        maxUnlockedStep = 1; currentActiveStep = 1; localStorage.setItem('maxUnlockedStep','1');
        checkAndUnlockSteps();
      }
    }

    function init() {
      const savedMaxStep = localStorage.getItem('maxUnlockedStep');
      if (savedMaxStep) maxUnlockedStep = parseInt(savedMaxStep, 10);
      else maxUnlockedStep = 1;

      renderCookieTable(); applySavedTheme(); updateSessionInfo(); updateGreeting();
      updateSessionPersistentStatus();

      const lastCategory = localStorage.getItem('last_category');
      if (lastCategory && getCookie('tracking_id')) {
        document.getElementById('tracking-info').textContent = `Tracking aktiv (ID: ${getCookie('tracking_id')}). Letzte Kategorie: ${lastCategory}`;
        showAdBanner(lastCategory);
      } else {
        document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
        hideAdBanner();
      }

      checkAndUnlockSteps();

      if (maxUnlockedStep > 1) markActiveStep(maxUnlockedStep);
      else markActiveStep(1);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
