<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wie Websites dich erkennen ‚Äî Interaktive Demo (√úberarbeitet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* ------------------------------------- */
    /*  CSS Variables & Base Styles          */
    /* ------------------------------------- */
    :root {
      --color-bg: #f6f8fa;
      --color-card: #ffffff;
      --color-primary: #4a90e2;
      --color-text-muted: #6b7280;
      --color-glass: rgba(255, 255, 255, 0.6);
      --color-border: #e6edf5;
      --color-shadow: rgba(2, 6, 23, 0.08);
      --color-shadow-light: rgba(2, 6, 23, 0.04);
      --gradient-header: linear-gradient(90deg, var(--color-primary), #2e6fb8);
      --gradient-info: linear-gradient(180deg, rgba(234, 244, 255, 0.5), transparent);
    }

    [data-theme="dark"] {
      --color-bg: #0f1724;
      --color-card: #0b1220;
      --color-primary: #60a5fa;
      --color-text-muted: #9ca3af;
      --color-glass: rgba(255, 255, 255, 0.03);
      --color-border: #2d3748; /* Darker border for dark theme */
      --color-shadow: rgba(0, 0, 0, 0.2); /* Stronger shadow in dark theme */
      --color-shadow-light: rgba(0, 0, 0, 0.1);
      --gradient-header: linear-gradient(90deg, var(--color-primary), #3f6eb8);
      --gradient-info: linear-gradient(180deg, rgba(0, 50, 100, 0.3), transparent);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--color-bg);
      color: var(--color-text-muted);
      line-height: 1.5;
    }

    /* ------------------------------------- */
    /*  Typography                           */
    /* ------------------------------------- */
    h1, h2, h3 {
      color: var(--color-primary);
      margin-top: 0;
    }
    h1 { font-size: 1.1rem; }
    h2 { margin-bottom: 0.5rem; }
    h3 { margin-bottom: 0.5rem; }

    p { margin-top: 0; }

    .muted {
      font-size: 0.9rem;
      color: var(--color-text-muted);
    }

    pre {
      background: rgba(0, 0, 0, 0.03);
      padding: 0.75rem;
      border-radius: 8px;
      overflow: auto;
      font-size: 0.92rem;
      color: var(--color-text-muted);
      white-space: pre-wrap; /* Allows text to wrap in pre tags */
    }

    /* ------------------------------------- */
    /*  Layout & Structure                   */
    /* ------------------------------------- */
    header {
      background: var(--gradient-header);
      color: white;
      padding: 1.25rem 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }
    header .brand {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    header h1 {
      margin: 0;
      color: white;
    }
    header p {
      margin: 0;
      font-size: 0.86rem;
      opacity: 0.95;
    }

    main {
      max-width: 1100px;
      margin: 1.25rem auto;
      padding: 1rem;
      position: relative; /* F√ºr das absolute positionierte Ad-Banner */
    }

    .layout {
      grid-template-columns: 450px 1fr;
      display: grid;
      gap: 1rem;
    }

    .sidebar {
      position: sticky;
      top: 1rem;
      align-self: start;
    }

    .card {
      background: var(--color-card);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 6px 20px var(--color-shadow);
      color: var(--color-text-muted);
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 600px;
    }

    section {
      padding: 1rem;
      border-radius: 12px;
      background: var(--color-card);
      box-shadow: 0 6px 20px var(--color-shadow-light);
    }

    section.card.locked {
      pointer-events: none;     /* Deaktiviert Klicks */
      opacity: 0;             
      filter: grayscale(100%);  /* Optional: schwarz-wei√ü */
      display: block;
    }

    .info {
      background: var(--gradient-info);
      padding: 0.6rem;
      border-left: 4px solid var(--color-primary);
      border-radius: 8px;
      color: var(--color-text-muted);
      text-align: justify;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      font-size: 0.82rem;
      color: var(--color-text-muted);
      margin-top: 1rem;
      padding-top: 1rem;
    }

    .content-spacer {
      height: 500px;  /* H√∂he des Spacers, anpassen wie du willst */
      width: 100%;
    }

    body::after {
      content: "";
      display: block;
      height: 400px; /* gew√ºnschte zus√§tzliche Scroll-H√∂he */
    }

    /* ------------------------------------- */
    /*  Components                           */
    /* ------------------------------------- */
    .progress {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }
    .step {
      flex: 1 1 auto;
      min-width: 0;
      background: var(--color-glass);
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      color: var(--color-text-muted);
      cursor: pointer;
    }
    .step.active {
      background: var(--gradient-header);
      color: white;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.7rem;
    }

    button {
      background: var(--color-primary);
      color: white;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.1s ease, background-color 0.1s ease;
    }
    .btn-ghost {
      background: transparent;
      color: var(--color-primary);
      border: 1px solid var(--color-glass);
    }
    button:active {
      transform: translateY(1px);
    }
    button:hover:not(:active) {
        opacity: 0.9;
    }


    .form-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
      flex-wrap: wrap;
    }
    input[type=text],
    input[type=password],
    select { /* Auch select-Element stylen */
      flex: 1;
      min-width: 150px;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      font-size: 0.95rem;
      background: var(--color-card);
      color: var(--color-text-muted);
    }
    input[type=text]:focus,
    input[type=password]:focus,
    select:focus { /* Auch select-Element stylen */
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--color-text-muted);
    }

    #map {
      height: 280px;
      border-radius: 8px;
      margin-top: 0.6rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
    }
    th,
    td {
      padding: 0.45rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-size: 0.9rem;
    }
    th {
      color: var(--color-text-muted);
    }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.45rem;
      border-radius: 999px;
      font-size: 0.78rem;
      background: var(--color-glass);
      color: var(--color-text-muted);
    }

    /* ------------------------------------- */
    /*  Ad Banner specific styles            */
    /* ------------------------------------- */
    #ad-banner {
      display: none;
      width: 100%;
      background: var(--color-card);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--color-shadow);
      padding: 0.75rem;
      text-align: center;
      margin-top: 1rem;
    }

    #ad-banner.active {
        display: block; /* Anzeigen, wenn aktiv */
        animation: fadeIn 0.3s ease-out;
    }

    #ad-banner h4 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        color: var(--color-primary);
    }

    #ad-banner img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    #ad-banner p {
        font-size: 0.85rem;
        color: var(--color-text-muted);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.97); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ------------------------------------- */
    /*  Responsive Design                    */
    /* ------------------------------------- */
    @media (max-width: 1400px) { /* Banner r√ºckt fr√ºher rein, wenn der Bildschirm schmaler wird */
        main {
          display: flex; /* Hauptbereich als Flexbox f√ºr flexible Anordnung */
          flex-direction: column; /* Standardm√§√üig untereinander */
          gap: 1rem;
          padding: 1rem;
          max-width: none; /* Keine maximale Breite f√ºr main */
        }

        .layout {
          grid-template-columns: 1fr; /* Einspaltig f√ºr das Layout-Grid */
          width: 100%; /* Layout nimmt volle Breite ein */
        }

        .sidebar {
          position: static; /* Sidebar nicht mehr sticky */
          width: 100%; /* Volle Breite der Sidebar */
          order: 2; /* Sidebar nach dem Content auf kleineren Screens */
        }

        .content {
          width: 100%; /* Content nimmt volle Breite ein */
          order: 1; /* Content zuerst auf kleineren Screens */
        }

        #ad-banner {
          position: static; /* Banner flie√üt im Dokumentenfluss mit */
          width: 100%; /* Volle Breite auf kleineren Bildschirmen */
          margin-top: 1rem;
          transform: translateX(0);
          order: 3; /* Ad-Banner nach Sidebar */
        }
      }
    @media (min-width: 1025px) and (max-width: 1400px) {
    main {
      flex-direction: row; /* Sidebar und Content nebeneinander auf Laptops */
      align-items: flex-start; /* Elemente oben ausrichten */
      justify-content: center; /* Zentrieren, falls Platz √ºbrig ist */
      flex-wrap: wrap; /* Erlaubt Umbruch, falls kein Platz ist */
    }

    .layout {
        grid-template-columns: 320px 1fr; /* Kleinere Sidebar, mehr Platz f√ºr Content */
        width: auto; /* Layout nimmt nur ben√∂tigte Breite ein */
        flex-grow: 1; /* Layout-Bereich kann wachsen */
    }

    .sidebar {
        width: auto; /* Breite wird vom Grid bestimmt */
        position: sticky; /* Sticky wieder aktivieren */
        top: 1rem;
        order: unset; /* Reihenfolge zur√ºcksetzen */
    }

    .content {
        width: auto; /* Breite wird vom Grid bestimmt */
        order: unset;
    }

    #ad-banner {
        position: sticky; /* Banner wieder sticky */
        top: 1rem;
        align-self: flex-start; /* Oben ausrichten */
        width: 250px; /* Feste Breite f√ºr das Banner */
        margin-left: 1rem; /* Abstand zur rechten Seite des Layouts */
        order: unset;
    }
  }

  @media (max-width: 1024px) { /* √úbergang zu Tablet/kleineren Ger√§ten */
    .layout {
      grid-template-columns: 1fr; /* Einspaltig f√ºr das Layout-Grid */
    }
    .sidebar {
      position: static; /* Sidebar nicht mehr sticky */
      width: 100%; /* Volle Breite */
    }
    /* Das Ad-Banner wird in der 1400px Media Query bereits auf static gesetzt und volle Breite,
      daher sind hier keine weiteren Anpassungen f√ºr das Banner n√∂tig, au√üer die Reihenfolge,
      wenn es auf Desktop-Layout umbricht. */
  }


  @media (max-width: 768px) { /* Mobilger√§te (oder sehr kleine Tablets) */
    header {
      flex-direction: column;
      align-items: flex-start;
      padding: 1rem;
    }
    header .brand {
      margin-bottom: 0.5rem;
    }
    .form-row {
      flex-direction: column;
    }
    input[type=text], input[type=password], select, button {
        width: 100%;
        min-width: unset;
    }
  }
  
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand">
      <div style="font-size:1.5rem">üç™</div>
      <div>
        <h1>Wie Websites dich erkennen</h1>
        <p>Interaktive Unterrichts-Demo ‚Äì Schulstufe: 9. Klasse / AHS 5. Klasse</p>
      </div>
    </div>
    <div style="display:flex; gap:.6rem; align-items:center">
      <div class="muted" id="welcome-text">Willkommen!</div>
      <button id="theme-toggle" class="btn-ghost">Dark</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <aside class="sidebar">
        <div class="card">
          <h2>Schritt-f√ºr-Schritt</h2>
          <div class="muted">F√ºhre die Schritte durch, um Cookies & Tracking zu verstehen.</div>
          <div class="progress" id="progress">
            <div class="step" data-step="1">1. Cookies</div>
            <div class="step" data-step="2">2. Login</div>
            <div class="step" data-step="3">3. Ger√§t</div>
            <div class="step" data-step="4">4. Standort</div>
            <div class="step" data-step="5">5. Tracking</div>
          </div>

          <div style="margin-top:.8rem" class="muted">Schnellaktionen</div>
          <div class="controls">
            <button onclick="toggleCookieTable()">Cookies anzeigen / verstecken</button>
            <button onclick="clearAllCookies()" class="btn-ghost">Alle l√∂schen</button>
            <button onclick="simulateVisit()" class="btn-ghost">Seite neu laden (sim.)</button>
          </div>

          <div style="margin-top:.8rem" class="muted">Cookie-√úbersicht</div>
          <div id="cookie-table"></div>
        </div>

        <div style="height:1rem"></div>

        <div class="card">
          <h2>Session vs Persistent</h2>
          <div class="muted">Session-Cookies existieren nur w√§hrend einer Browser-Sitzung. Persistente Cookies haben ein Ablaufdatum.</div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem">
            <button onclick="setPersistentDemo()">Persistent setzen</button>
            <button onclick="setSessionDemo()" class="btn-ghost">Session setzen</button>
          </div>
        </div>
      </aside>

      <section class="content">
        <section class="card" data-step="1">
          <h3>üç™ 1. Cookies ‚Äì pers√∂nliche Begr√º√üung & Demo</h3>
          <div class="info">Diese Sektion zeigt wie persistent gespeicherte Cookies (z. B. Theme-Pr√§ferenz) und Session-Cookies (Login-Sitzung) funktionieren. Deine Begr√º√üung wird durch den Login-Status gesteuert. Es werden <b>keine</b> echten Tracker gesetzt.</div>

          <div style="margin-top:.6rem">
            <div style="margin-top:.5rem" class="muted">Aktuelle Begr√º√üung:</div>
            <pre id="greeting">Hallo, Sch√ºler!</pre>
          </div>
        </section>

        <section class="card" data-step="2">
          <h3>üîê 2. Mini-Register / Login (lokal & ohne Server)</h3>
          <div class="info">Registrieren & Anmelden werden nur lokal simuliert. Registrierte Daten werden im <b>localStorage</b> gespeichert. Die Login-Sitzung demonstriert einen Session-Cookie.</div>

          <div style="margin-top:.6rem">
            <div class="form-row">
              <input id="reg-username" type="text" placeholder="Benutzername" />
              <input id="reg-password" type="password" placeholder="Passwort" />
              <button onclick="registerUser()">Registrieren</button>
            </div>

            <div class="form-row" style="margin-top:.5rem">
              <input id="login-username" type="text" placeholder="Benutzername" />
              <input id="login-password" type="password" placeholder="Passwort" />
              <button onclick="loginUser()">Login</button>
              <button onclick="logoutUser()" class="btn-ghost">Logout</button>
            </div>

            <div style="margin-top:.6rem" class="muted">Session-Info:</div>
            <pre id="session-info">Nicht eingeloggt.</pre>
          </div>
        </section>

        <section class="card" data-step="3">
          <h3>üíª 3. Ger√§tedaten</h3>
          <div class="info">Technische Informationen, die Websites mit JavaScript auslesen k√∂nnen. URL: https://amiunique.org</div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center">
            <button onclick="showDeviceInfo()">Daten anzeigen</button>
            <button onclick="clearDeviceInfo()" class="btn-ghost">L√∂schen</button>
          </div>
          <pre id="device-info">Noch keine Daten angezeigt.</pre>
        </section>

        <section class="card" data-step="4">
          <h3>üìç 4. Standort (nur mit Zustimmung)</h3>
          <div class="info">Wenn erlaubt, zeigt die Karte ungef√§hr, wo sich das Ger√§t befindet. Besuche die Seite auch mit deinem Handy und vergleiche die Genauigkeit. Handy -> GPS -> Genauer</div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem; align-items:center">
            <button onclick="getLocation()">Standort abfragen</button>
            <button onclick="clearLocation()" class="btn-ghost">Karte verstecken</button>
          </div>
          <pre id="location-info">Noch keine Standortdaten.</pre>
          <div id="map" style="display:none"></div>
        </section>

        <section class="card" data-step="5">
          <h3>üì¢ 5. Tracking-Simulation</h3>
          <div class="info">Simuliere ein Werbecookie (tracking_id) und beobachte, wie eine Seite dich bei einem erneuten Besuch "wiedererkennen" k√∂nnte. W√§hle ein Interesse, um ein gezieltes Werbebanner zu simulieren.</div>
          <div style="margin-top:.6rem">
            <div class="form-row">
              <label for="ad-category-select">Was interessiert dich?</label>
              <select id="ad-category-select">
                <option value="">W√§hle ein Interesse</option>
                <option value="Mode">üëó Mode</option>
                <option value="Musik">üéß Musik</option>
                <option value="Tiere">üêæ Tiere</option>
                <option value="Kochen">üç≥ Kochen</option>
                <option value="Gaming">üéÆ Gaming</option>
              </select>
              <button onclick="setTracking()">Tracking setzen</button>
              <button onclick="simulateAd()" class="btn-ghost">Simuliere Ad-Targeting</button>
              <button onclick="clearTracking()" class="btn-ghost">Tracking l√∂schen</button>
            </div>
            <div style="margin-top:.5rem" class="muted">Tracking-Status:</div>
            <pre id="tracking-info">Tracking nicht gesetzt.</pre>
            <div id="ad-banner" class="card">
              <h4>Angebot nur f√ºr dich!</h4>
              <img id="ad-image" src="" alt="Werbebild">
              <p id="ad-text"></p>
              <button class="btn-ghost" onclick="hideAdBanner()">Schlie√üen</button>
            </div>
          </div>
        </section>

        <div class="content-spacer"></div>
        <footer>¬© Unterrichts-Demo ‚Äì Keine Daten werden an Server √ºbertragen.</footer>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ----------------------------- Helpers ----------------------------- */
    let maxUnlockedStep;
    let currentActiveStep = 1;
    /**
     * Setzt einen Cookie. Wenn `days` null oder undefined ist, wird es ein Session-Cookie.
     * @param {string} name - Der Name des Cookies.
     * @param {string} value - Der Wert des Cookies.
     * @param {number|null} [days] - Anzahl der Tage, bis der Cookie abl√§uft (f√ºr persistente Cookies).
     */
    function setCookie(name, value, days) {
      let cookieString = `${name}=${encodeURIComponent(value)}; path=/`;
      if (typeof days === 'number' && days > 0) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        cookieString += `; expires=${d.toUTCString()}`;
      }
      document.cookie = cookieString;
      renderCookieTable(); // Tabelle nach jeder Cookie-√Ñnderung aktualisieren
      checkAndUnlockSteps(); 
    }

    /**
     * Holt den Wert eines Cookies.
     * @param {string} name - Der Name des Cookies.
     * @returns {string|null} Der Wert des Cookies oder null, wenn nicht gefunden.
     */
    function getCookie(name) {
      const match = document.cookie.match(`(^|;)\\s*${name}=([^;]+)`);
      return match ? decodeURIComponent(match.pop()) : null;
    }

    /**
     * L√∂scht einen Cookie.
     * @param {string} name - Der Name des zu l√∂schenden Cookies.
     */
    function deleteCookie(name) {
      document.cookie = `${name}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC`;
      renderCookieTable(); // Tabelle nach jeder Cookie-√Ñnderung aktualisieren
      checkAndUnlockSteps();
    }

    /**
     * Rendert die Cookie-Tabelle im Sidebar.
     */
    function renderCookieTable() {
      const box = document.getElementById('cookie-table');
      const cookies = document.cookie
        .split(';')
        .map(c => c.trim())
        .filter(Boolean);

      if (!cookies.length) {
        box.innerHTML = '<div class="muted">Keine Cookies gesetzt.</div>';
        return;
      }

      let html = '<table><thead><tr><th>Name</th><th>Wert</th><th></th></tr></thead><tbody>';
      cookies.forEach(c => {
        const [key, val] = c.split('=');
        html += `<tr><td>${key}</td><td>${decodeURIComponent(val || '')}</td><td><button onclick="deleteCookie('${key}')" class="btn-ghost">L√∂schen</button></td></tr>`;
      });
      html += '</tbody></table>';
      box.innerHTML = html;
      updateGreeting();
    }

    /**
     * Aktualisiert den Begr√º√üungstext und den Willkommenstext im Header.
     */
    function updateGreeting() {
      const greetingElement = document.getElementById('greeting');
      const welcomeTextElement = document.getElementById('welcome-text');
      const name = sessionStorage.getItem('username');

      greetingElement.textContent = name ? `Hallo, ${name}!` : 'Hallo, Sch√ºler!';
      welcomeTextElement.textContent = name ? `Angemeldet: ${name}` : 'Willkommen!';
    }

    /* --------------------- Persistent vs Session Demo -------------------- */
    function setPersistentDemo() {
      setCookie('demo_persistent', 'persistentValue', 365);
      alert('Persistent Cookie "demo_persistent" gesetzt (l√§uft 365 Tage)');
    }

    function setSessionDemo() {
      setCookie('demo_session', 'tempValue');
      alert('Session Cookie "demo_session" gesetzt (verschwindet beim Schlie√üen des Tabs/Browsers)');
    }

    /* --------------------- Device info -------------------- */
    function showDeviceInfo() {
      const info = {
        'User Agent': navigator.userAgent,
        'Sprache': navigator.language,
        'Cookies aktiviert': navigator.cookieEnabled,
        'Plattform': navigator.platform,
        'Bildschirm': `${window.screen.width}√ó${window.screen.height}`,
        'Zeitzone': Intl.DateTimeFormat().resolvedOptions().timeZone,
        'Uhrzeit': new Date().toLocaleString()
      };
      let text = '';
      for (const k in info) text += `‚Ä¢ ${k}: ${info[k]}\n`;
      document.getElementById('device-info').textContent = text;
      checkAndUnlockSteps();
    }

    function clearDeviceInfo() {
      document.getElementById('device-info').textContent = 'Noch keine Daten angezeigt.';
      checkAndUnlockSteps();
    }

    /* --------------------- Geolocation + Leaflet -------------------- */
    let map, marker;

    function getLocation() {
      const out = document.getElementById('location-info');
      const mapDiv = document.getElementById('map');
      if (!navigator.geolocation) {
        out.textContent = '‚ùå Geolocation nicht unterst√ºtzt.';
        return;
      }
      out.textContent = 'üìç Standort wird abgefragt...';
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        out.textContent = `‚úÖ Standort:\nBreitengrad: ${lat.toFixed(5)}\nL√§ngengrad: ${lon.toFixed(5)}\nGenauigkeit: ¬±${Math.round(acc)} m`;
        mapDiv.style.display = 'block';

        if (!map) {
          map = L.map('map').setView([lat, lon], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap-Mitwirkende'
          }).addTo(map);
        } else {
          map.setView([lat, lon], 13);
        }

        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map).bindPopup('üìç Dein Standort').openPopup();
        checkAndUnlockSteps();
      }, err => {
        out.textContent = '‚ö†Ô∏è Standort konnte nicht ermittelt werden oder wurde abgelehnt.';
        mapDiv.style.display = 'none';
        checkAndUnlockSteps();
      });
    }

    function clearLocation() {
      document.getElementById('map').style.display = 'none';
      document.getElementById('location-info').textContent = 'Noch keine Standortdaten.';
      if (marker) {
        marker.remove();
        marker = null;
      }
      if (map) {
        map.remove();
        map = null;
      }
      checkAndUnlockSteps();
    }

    /* --------------------- Tracking Simulation -------------------- */
    // Objekt f√ºr Ad-Inhalte
    const adContent = {
        'Mode': {
            image: 'images/Fashion.png',
            text: 'Entdecke die neuesten Trends! Exklusive Angebote f√ºr dich.',
            alt: 'Modische Kleidung'
        },
        'Musik': {
            image: 'images/Headphones.png',
            text: 'Tauche ein in deine Lieblingsmusik! Headsets & mehr im Angebot.',
            alt: 'Kopfh√∂rer'
        },
        'Tiere': {
            image: 'images/Cat_Rice_Cooker.png',
            text: 'Verw√∂hne deinen Vierbeiner! Gesundes Futter und Spielzeug.',
            alt: 'Katzenfutter'
        },
        'Kochen': {
            image: 'images/Cat_Rice_Cooker.png',
            text: 'Kreiere Meisterwerke in deiner K√ºche! Entdecke unsere Reiskocher.',
            alt: 'Reiskocher'
        },
        'Gaming': {
            image: 'images/Headphones.png',
            text: 'Hol dir den entscheidenden Vorteil! Top-Gaming-Gear warten auf dich.',
            alt: 'Gaming Headset'
        }
    };

    function setTracking() {
      const id = Math.random().toString(36).slice(2, 10);
      setCookie('tracking_id', id, 90);
      document.getElementById('tracking-info').textContent = `Tracking gesetzt: ${id}`;
    }

    function simulateAd() {
      const id = getCookie('tracking_id');
      if (!id) return alert('Kein Tracking gesetzt. Bitte zuerst "Tracking setzen".');

      const categorySelect = document.getElementById('ad-category-select');
      const selectedCategory = categorySelect.value;

      if (!selectedCategory) return alert('Bitte w√§hle ein Interesse, um Ad-Targeting zu simulieren.');

      // Speichern der ausgew√§hlten Kategorie
      localStorage.setItem('last_category', selectedCategory);

      alert(`Simulierter Besuch: ${selectedCategory}. Beim n√§chsten Besuch k√∂nnte eine Ad f√ºr ${selectedCategory} erscheinen.`);
      document.getElementById('tracking-info').textContent = `Tracking aktiv (${id}). Letzte Kategorie: ${selectedCategory}`;

      showAdBanner(selectedCategory); // Zeige das Banner sofort nach der Auswahl
      checkAndUnlockSteps();
    }

    function clearTracking() {
      deleteCookie('tracking_id');
      localStorage.removeItem('last_category');
      document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
      renderCookieTable();
      hideAdBanner(); // Banner beim L√∂schen des Trackings ausblenden
      checkAndUnlockSteps();
    }

    function simulateVisit() {
      const id = getCookie('tracking_id');
      const cat = localStorage.getItem('last_category');

      if (id && cat) {
        alert(`Wiederkehrender Besuch erkannt. Tracking-ID ${id} ‚Üí m√∂gliche Ad f√ºr ${cat}`);
        showAdBanner(cat); // Banner bei erneutem Besuch anzeigen
      } else if (id) {
        alert(`Wiederkehrender Besucher (Tracking-ID ${id}). Kein Kategorie-Profil vorhanden.`);
        hideAdBanner();
      } else {
        alert('Kein Tracking vorhanden ‚Äî Besucher erscheint neu.');
        hideAdBanner();
      }
      // Schritte markieren, wenn Daten vorhanden sind (angepasste Nummern)
      checkAndUnlockSteps();
    }

    /**
     * Zeigt das Ad-Banner mit Inhalten basierend auf der Kategorie.
     * @param {string} category - Die Produktkategorie (z.B. 'Mode', 'Musik').
     */
    function showAdBanner(category) {
        const banner = document.getElementById('ad-banner');
        const img = document.getElementById('ad-image');
        const text = document.getElementById('ad-text');

        const content = adContent[category];
        if (content) {
            img.src = content.image;
            img.alt = content.alt;
            text.textContent = content.text;
            banner.classList.add('active');
        } else {
            hideAdBanner();
        }
    }

    /**
     * Blendet das Ad-Banner aus.
     */
    function hideAdBanner() {
        const banner = document.getElementById('ad-banner');
        banner.classList.remove('active');
        // Optional: Inhalt leeren, wenn es ausgeblendet ist
        document.getElementById('ad-image').src = '';
        //document.getElementById('ad-image').alt = '';
        document.getElementById('ad-text').textContent = '';
    }


    /* --------------------- Mini Register / Login -------------------- */
    function registerUser() {
      const usernameInput = document.getElementById('reg-username');
      const passwordInput = document.getElementById('reg-password');
      const u = usernameInput.value.trim();
      const p = passwordInput.value;

      if (!u || !p) return alert('Benutzername + Passwort erforderlich');

      const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
      if (users[u]) return alert('Benutzername existiert bereits');

      users[u] = {
        password: btoa(p)
      };
      localStorage.setItem('demo_users', JSON.stringify(users));
      alert('Registrierung erfolgreich (lokal). Du kannst dich jetzt einloggen.');

      usernameInput.value = '';
      passwordInput.value = '';
    }

    function loginUser() {
      const usernameInput = document.getElementById('login-username');
      const passwordInput = document.getElementById('login-password');
      const u = usernameInput.value.trim();
      const p = passwordInput.value;

      if (!u || !p) return alert('Bitte Benutzername + Passwort eingeben');

      const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
      if (!users[u] || users[u].password !== btoa(p)) return alert('Ung√ºltige Anmeldedaten');

      setCookie('session_user', u);
      sessionStorage.setItem('username', u);
      updateSessionInfo();
      renderCookieTable();
      alert('Du bist jetzt eingeloggt.');
      checkAndUnlockSteps();

      usernameInput.value = '';
      passwordInput.value = '';
    }

    function logoutUser() {
      sessionStorage.removeItem('username');
      deleteCookie('session_user');
      updateSessionInfo();
      renderCookieTable();
      alert('Du wurdest ausgeloggt.');
      checkAndUnlockSteps();
    }

    function updateSessionInfo() {
      const sessionUser = sessionStorage.getItem('username');
      document.getElementById('session-info').textContent = sessionUser ? `Eingeloggt als ${sessionUser} (Session-Cookie)` : 'Nicht eingeloggt.';
      updateGreeting();
    }

    // --- Cookies √úbersicht ein- und ausklappbar ---
    let cookiesVisible = true;

    function toggleCookieTable() {
      const box = document.getElementById('cookie-table');
      cookiesVisible = !cookiesVisible;
      box.style.display = cookiesVisible ? 'block' : 'none';
    }

    /* --------------------- UI: Theme, Progress -------------------- */
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      const root = document.body;
      const theme = root.getAttribute('data-theme');
      const nextTheme = theme === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', nextTheme);
      themeToggle.textContent = nextTheme === 'dark' ? 'Light' : 'Dark';
      setCookie('theme_pref', nextTheme, 365);
    });

    function applySavedTheme() {
      const savedTheme = getCookie('theme_pref');
      if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'Light' : 'Dark';
      }
    }

    function markActiveStep(stepNumber) {
        document.querySelectorAll('.step').forEach(el => {
            el.classList.toggle('active', Number(el.getAttribute('data-step')) === stepNumber);
        });
        currentActiveStep = stepNumber; // Speichert den aktuell aktiven Schritt
    }

    function checkAndUnlockSteps() {
      // Schritt 1: Cookies - immer aktiv.
      
      if (maxUnlockedStep < 2) maxUnlockedStep = 2;

      // Schritt 2: Login - abgeschlossen, wenn der Benutzer eingeloggt ist (sessionStorage 'username')
      if (sessionStorage.getItem('username')) {
        if (maxUnlockedStep < 3) maxUnlockedStep = 3; // Unlock Step 3 (Ger√§t)
      } else {
        // Wenn ausgeloggt, dann maxUnlockedStep auf 2 zur√ºcksetzen, aber nicht unter 1
        if (maxUnlockedStep >= 3) {
          maxUnlockedStep = 2;
        }
      }

      if (document.getElementById('device-info').textContent !== 'Noch keine Daten angezeigt.') {
        if (maxUnlockedStep < 4) maxUnlockedStep = 4; // Unlock Step 4 (Standort)
      }

      if (document.getElementById('location-info').textContent.startsWith('‚úÖ Standort:')) {
        if (maxUnlockedStep < 5) maxUnlockedStep = 5; // Unlock Step 5 (Tracking)
      }

      localStorage.setItem('maxUnlockedStep', maxUnlockedStep.toString());

      unlockStepsUI(maxUnlockedStep);
      if (currentActiveStep > maxUnlockedStep || !document.querySelector(`.step[data-step="${currentActiveStep}"]`)) {
          markActiveStep(maxUnlockedStep);
      } else {
          markActiveStep(currentActiveStep); // Ansonsten den aktuellen aktiven Schritt beibehalten
      }
    }

    function unlockStepsUI(unlockedCount) {
      document.querySelectorAll('.step').forEach(step => {
        const stepNum = Number(step.getAttribute('data-step'));
        // Die Sidebar-Schritte sind klickbar und sichtbar bis zum freigeschalteten Level
        step.style.pointerEvents = stepNum <= unlockedCount ? 'auto' : 'none';
        step.style.opacity = stepNum <= unlockedCount ? '1' : '0.4';

        // Event-Listener f√ºr Sidebar-Schritte hinzuf√ºgen, wenn noch nicht geschehen
        if (stepNum <= unlockedCount && !step.dataset.listenerAdded) {
          step.addEventListener('click', () => {
            markActiveStep(stepNum);
            scrollToSection(stepNum);
          });
          step.dataset.listenerAdded = 'true'; // Markieren, dass Listener hinzugef√ºgt wurde
        }
      });

      document.querySelectorAll('section.card[data-step]').forEach(sec => {
        const stepNum = Number(sec.getAttribute('data-step'));
        sec.classList.toggle('locked', stepNum > unlockedCount);
      });
    }

    function scrollToSection(stepNumber) {
        setContentMinHeight(); // <-- sicherstellen, dass gen√ºgend H√∂he vorhanden ist

        const section = document.querySelector(`section.card[data-step="${stepNumber}"]`);
        const progressCard = document.querySelector('.sidebar .card:first-child');

        if (section && progressCard) {
            const progressRect = progressCard.getBoundingClientRect();
            const sectionTop = section.getBoundingClientRect().top + window.scrollY;

            let scrollTarget = sectionTop - progressRect.top;

            // maximaler Scrollwert (Dokumenth√∂he minus Viewporth√∂he)
            const maxScroll = document.body.scrollHeight - window.innerHeight;
            if (scrollTarget > maxScroll) scrollTarget = maxScroll;

            window.scrollTo({
                top: scrollTarget,
                behavior: 'smooth'
            });
        }
    }

    // function adjustContentHeight() {
    //     const main = document.querySelector('main');
    //     const sidebar = document.querySelector('.sidebar .card:first-child'); // Step-by-Step Card
    //     const content = document.querySelector('section.content');

    //     if (!main || !sidebar || !content) return;

    //     // Sidebar-H√∂he + Abstand nach unten
    //     const sidebarRect = sidebar.getBoundingClientRect();
    //     const sidebarHeight = sidebarRect.height;

    //     // Berechne bisherige Content-H√∂he
    //     const contentHeight = content.scrollHeight;

    //     // Ben√∂tigte Mindesth√∂he, damit letzte Section auf Sidebar-H√∂he kommt
    //     const requiredHeight = sidebarHeight;

    //     if (contentHeight < requiredHeight) {
    //         content.style.minHeight = requiredHeight + 'px';
    //     } else {
    //         content.style.minHeight = 'auto';
    //     }
    // }
    
    function setContentMinHeight() {
        const sidebar = document.querySelector('.sidebar .card:first-child');
        const content = document.querySelector('section.content');
        if (sidebar && content) {
            content.style.minHeight = sidebar.offsetHeight + 'px';
        }
    }

    // Event-Listener
    window.addEventListener('resize', setContentMinHeight);
    window.addEventListener('load', setContentMinHeight);

    /* --------------------- Small actions -------------------- */
    function clearAllCookies() {
      if (confirm('Alle Cookies, LocalStorage und SessionStorage l√∂schen? Dies l√∂scht auch Login-Sessions und Tracking-Daten.')) {
        document.cookie.split(';').forEach(c => {
          const name = c.split('=')[0].trim();
          if (name) deleteCookie(name);
        });

        localStorage.clear();
        sessionStorage.clear();

        updateSessionInfo();
        updateGreeting();
        document.getElementById('device-info').textContent = 'Noch keine Daten angezeigt.';
        document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
        clearLocation();
        renderCookieTable();
        hideAdBanner(); // Banner auch beim Leeren aller Daten ausblenden
        alert('Alle Daten gel√∂scht.');
        maxUnlockedStep = 1;
        currentActiveStep = 1;
        localStorage.setItem('maxUnlockedStep', '1');
        checkAndUnlockSteps(); 
      }
    }

    /* --------------------- Init -------------------- */
    function init() {
      const savedMaxStep = localStorage.getItem('maxUnlockedStep');
      if (savedMaxStep) {
          maxUnlockedStep = parseInt(savedMaxStep, 10);
      } else {
          maxUnlockedStep = 1; // Standardwert, wenn nichts gespeichert ist
      }
      
      renderCookieTable();
      applySavedTheme();
      updateSessionInfo();
      updateGreeting();

      const lastCategory = localStorage.getItem('last_category');
      if (lastCategory && getCookie('tracking_id')) {
          document.getElementById('tracking-info').textContent = `Tracking aktiv (ID: ${getCookie('tracking_id')}). Letzte Kategorie: ${lastCategory}`;
          showAdBanner(lastCategory);
      } else {
          document.getElementById('tracking-info').textContent = 'Tracking nicht gesetzt.';
          hideAdBanner();
      }

      checkAndUnlockSteps();
      
      if (maxUnlockedStep > 1) {
          markActiveStep(maxUnlockedStep); 
      } else {
          markActiveStep(1); 
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>